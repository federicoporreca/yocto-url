<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>YoctoURL</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT"
      crossorigin="anonymous"
    />
  </head>
  <body class="bg-light">
    <% if (username) { %>
    <div class="container py-5">
      <div class="text-center mb-5">
        <h1 class="fw-bold">YoctoURL</h1>
        <p class="text-muted">
          Hi <%= username %>! Fill in the form to create a short URL
        </p>
      </div>
      <div class="card mb-4">
        <div class="card-body">
          <form method="POST" action="/urls">
            <div class="mb-3">
              <label for="url" class="form-label">URL</label>
              <input
                type="text"
                class="form-control"
                id="url"
                name="url"
                placeholder="https://example.com"
                required
              />
            </div>
            <div class="row g-3 mb-3">
              <div class="col-md-8">
                <label for="slug" class="form-label">Slug</label>
                <input
                  type="text"
                  class="form-control"
                  id="slug"
                  name="slug"
                  placeholder="e.g. my-link"
                  required
                />
              </div>
              <div class="col-md-4 d-flex align-items-end">
                <div class="form-check mt-2">
                  <input
                    type="checkbox"
                    class="form-check-input"
                    id="random"
                    name="random"
                    onchange="handleRandomCheckboxClick(this)"
                  />
                  <label for="random" class="form-check-label">Random</label>
                </div>
              </div>
            </div>
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label for="expiry" class="form-label">Expiry</label>
                <input
                  type="datetime-local"
                  class="form-control"
                  id="expiry"
                  name="expiry"
                  required
                />
              </div>
              <div class="col-md-6">
                <label for="offset" class="form-label">Timezone</label>
                <select class="form-select" id="offset" name="offset" required>
                  <option value="-12:00">UTC-12:00</option>
                  <option value="-11:00">UTC-11:00</option>
                  <option value="-10:00">UTC-10:00</option>
                  <option value="-09:00">UTC-09:00</option>
                  <option value="-08:00">UTC-08:00</option>
                  <option value="-07:00">UTC-07:00</option>
                  <option value="-06:00">UTC-06:00</option>
                  <option value="-05:00">UTC-05:00</option>
                  <option value="-04:00">UTC-04:00</option>
                  <option value="-03:00">UTC-03:00</option>
                  <option value="-02:00">UTC-02:00</option>
                  <option value="-01:00">UTC-01:00</option>
                  <option value="+00:00" selected>UTC</option>
                  <option value="+01:00">UTC+01:00</option>
                  <option value="+02:00">UTC+02:00</option>
                  <option value="+03:00">UTC+03:00</option>
                  <option value="+04:00">UTC+04:00</option>
                  <option value="+05:00">UTC+05:00</option>
                  <option value="+06:00">UTC+06:00</option>
                  <option value="+07:00">UTC+07:00</option>
                  <option value="+08:00">UTC+08:00</option>
                  <option value="+09:00">UTC+09:00</option>
                  <option value="+10:00">UTC+10:00</option>
                  <option value="+11:00">UTC+11:00</option>
                  <option value="+12:00">UTC+12:00</option>
                  <option value="+13:00">UTC+13:00</option>
                  <option value="+14:00">UTC+14:00</option>
                </select>
              </div>
            </div>
            <div class="form-check mb-4">
              <input
                type="checkbox"
                class="form-check-input"
                id="permanent"
                name="permanent"
                onchange="handlePermanentCheckboxClick(this)"
              />
              <label for="permanent" class="form-check-label">Permanent</label>
            </div>
            <div class="d-grid">
              <button type="submit" class="btn btn-primary">
                Create short URL
              </button>
            </div>
          </form>
        </div>
      </div>
      <% if (error) { %>
      <p><%= error %></p>
      <% }%>
      <h4 class="mb-3">Your short URLs</h4>
      <% if (urls.length === 0) { %>
      <p class="text-muted">No short URLs yet. Create your first one above!</p>
      <% } %> <% for (const [i, value] of urls.entries()) { %>
      <div class="accordion" id="accordion">
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button
              class="accordion-button collapsed"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#collapse-<%= i %>"
              aria-expanded="false"
              aria-controls="collapse-<%= i %>"
            >
              <%= value.short_url %> (<%= value.original_url %>)
            </button>
          </h2>
          <div
            id="collapse-<%= i %>"
            class="accordion-collapse collapse"
            data-bs-parent="#accordion"
          >
            <div class="accordion-body">
              <% if (value.visits.length === 0) { %> No visits yet <% } else {
              %>
              <table class="table">
                <thead>
                  <tr>
                    <th scope="col">Date</th>
                    <th scope="col">Visits</th>
                  </tr>
                </thead>
                <tbody>
                  <% for (const day of value.visits) { %>
                  <tr>
                    <td><%= day.date %></td>
                    <td><%= day.count %></td>
                  </tr>
                  <% } %>
                </tbody>
              </table>
              <% } %>
            </div>
          </div>
        </div>
      </div>
      <% } %>
    </div>
    <% } else { %>
    <div
      class="container d-flex flex-column justify-content-center align-items-center vh-100"
    >
      <div class="text-center">
        <h1 class="fw-bold mb-3">Welcome to YoctoURL!</h1>
        <p class="text-muted mb-4">
          Create and manage your own custom short URLs
        </p>
        <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
          <a href="/login" class="btn btn-primary btn-lg">Log in</a>
          <a href="/signup" class="btn btn-outline-secondary btn-lg">Sign up</a>
        </div>
      </div>
    </div>
    <% } %>
    <script>
      const getCurrentUtcOffset = (date = new Date()) => {
        const offset = -date.getTimezoneOffset();
        const sign = offset >= 0 ? "+" : "-";
        const hours = String(Math.floor(Math.abs(offset) / 60)).padStart(
          2,
          "0"
        );
        const minutes = String(Math.abs(offset) % 60).padStart(2, "0");
        return `${sign}${hours}:${minutes}`;
      };

      document.getElementById("offset").value = getCurrentUtcOffset();

      const slugInput = document.getElementById("slug");
      const expiryInput = document.getElementById("expiry");
      const offsetInput = document.getElementById("offset");

      const handleRandomCheckboxClick = (checkbox) => {
        slugInput.disabled = checkbox.checked;
      };

      const handlePermanentCheckboxClick = (checkbox) => {
        expiryInput.disabled = checkbox.checked;
        offsetInput.disabled = checkbox.checked;
      };
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
