<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>YoctoURL</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <% if (username) { %>
    <h1>Hi <%= username %>! Create a short URL</h1>
    <form method="POST" action="/urls">
      <div class="mb-3">
        <label for="url" class="form-label">URL</label>
        <input type="text" class="form-control" id="url" name="url" required />
      </div>
      <div class="mb-3">
        <label for="slug" class="form-label">Slug</label>
        <input
          type="text"
          class="form-control"
          id="slug"
          name="slug"
          required
        />
      </div>
      <div class="mb-3 form-check">
        <input
          type="checkbox"
          class="form-check-input"
          id="random"
          name="random"
          onchange="handleRandomCheckboxClick(this)"
        />
        <label for="random" class="form-check-label">Random</label>
      </div>
      <div class="mb-3">
        <label for="expiry" class="form-label">Expiry</label>
        <input
          type="datetime-local"
          class="form-control"
          id="expiry"
          name="expiry"
          required
        />
      </div>
      <div class="mb-3">
        <label for="offset" class="form-label">Timezone</label>
        <select class="form-select" id="offset" name="offset" required>
          <option value="-12:00">UTC-12:00</option>
          <option value="-11:00">UTC-11:00</option>
          <option value="-10:00">UTC-10:00</option>
          <option value="-09:00">UTC-09:00</option>
          <option value="-08:00">UTC-08:00</option>
          <option value="-07:00">UTC-07:00</option>
          <option value="-06:00">UTC-06:00</option>
          <option value="-05:00">UTC-05:00</option>
          <option value="-04:00">UTC-04:00</option>
          <option value="-03:00">UTC-03:00</option>
          <option value="-02:00">UTC-02:00</option>
          <option value="-01:00">UTC-01:00</option>
          <option value="+00:00" selected>UTC</option>
          <option value="+01:00">UTC+01:00</option>
          <option value="+02:00">UTC+02:00</option>
          <option value="+03:00">UTC+03:00</option>
          <option value="+04:00">UTC+04:00</option>
          <option value="+05:00">UTC+05:00</option>
          <option value="+06:00">UTC+06:00</option>
          <option value="+07:00">UTC+07:00</option>
          <option value="+08:00">UTC+08:00</option>
          <option value="+09:00">UTC+09:00</option>
          <option value="+10:00">UTC+10:00</option>
          <option value="+11:00">UTC+11:00</option>
          <option value="+12:00">UTC+12:00</option>
          <option value="+13:00">UTC+13:00</option>
          <option value="+14:00">UTC+14:00</option>
        </select>
      </div>
      <div class="mb-3 form-check">
        <input
          type="checkbox"
          class="form-check-input"
          id="permanent"
          name="permanent"
          onchange="handlePermanentCheckboxClick(this)"
        />
        <label for="permanent" class="form-check-label">Permanent</label>
      </div>
      <button type="submit" class="btn btn-primary">Shorten</button>
    </form>
    <% if (error) { %>
    <p><%= error %></p>
    <% }%>
    <h1>Your short URLs</h1>
    <% for (const [i, value] of urls.entries()) { %>
    <div class="accordion" id="accordion">
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button
            class="accordion-button"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#collapse-<%= i %>"
            aria-expanded="true"
            aria-controls="collapseOne"
          >
            <%= value.slug %> (<%= value.original_url %>)
          </button>
        </h2>
        <div
          id="collapse-<%= i %>"
          class="accordion-collapse collapse"
          data-bs-parent="#accordion"
        >
          <div class="accordion-body">
            <% if (value.visits.length === 0) { %>
            No visits
            <% } else { %>
            <table class="table">
              <thead>
                <tr>
                  <th scope="col">Date</th>
                  <th scope="col">Visits</th>
                </tr>
              </thead>
              <tbody>
                <% for (const day of value.visits) { %>
                <tr>
                  <td><%= day.date %></td>
                  <td><%= day.count %></td>
                </tr>
                <% } %>
              </tbody>
            </table>
            <% } %>
          </div>
        </div>
      </div>
    <% } %> <% } else { %>
    <h1>Welcome to YoctoURL!</h1>
    <p>
      <a href="/login">Log in</a> or <a href="/signup">sign up</a> to generate
      short URLs
    </p>
    <% } %>
    <script>
      const getCurrentUtcOffset = (date = new Date()) => {
        const offset = -date.getTimezoneOffset();
        const sign = offset >= 0 ? '+' : '-';
        const hours = String(Math.floor(Math.abs(offset) / 60)).padStart(2, '0');
        const minutes = String(Math.abs(offset) % 60).padStart(2, '0');
        return `${sign}${hours}:${minutes}`;
      }

      document.getElementById('offset').value = getCurrentUtcOffset()

      const slugInput = document.getElementById("slug");
      const expiryInput = document.getElementById("expiry");
      const offsetInput = document.getElementById("offset");

      const handleRandomCheckboxClick = (checkbox) => {
        slugInput.disabled = checkbox.checked;
      };

      const handlePermanentCheckboxClick = (checkbox) => {
        expiryInput.disabled = checkbox.checked;
        offsetInput.disabled = checkbox.checked;
      };
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
